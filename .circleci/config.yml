version: 2.1

orbs:
  docker: circleci/docker@2.6.0

executors:
  docker-publisher: 
    environment:
      TAG: 0.1.$CIRCLE_BUILD_NUM
      IMAGE_NAME: $DOCKER_USERNAME/circle-ci-weather-app:$TAG
    docker: # Each job requires specifying an executor
    # (either docker, macos, or machine), see
      - image: circleci/node:latest
        auth:
            username: $DOCKER_USERNAME
            password: $DOCKER_PASSWORD

jobs:
    publishLatestToHub: 
      executor: docker-publisher
      
      steps: 
        - checkout
        - setup_remote_docker
        - run:
            name: Build Docker image
            command: |
              docker build -t $IMAGE_NAME .
        - run: 
            name: Publish Docker Image to Docker Hub
            command: |
              echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
              docker build -t $IMAGE_NAME .
              docker push $IMAGE_NAME

workflows:
  build-master:
    jobs:
       - publishLatestToHub